<!DOCTYPE html>
<html>
<head>
    <title>TuniGuard JWT Frontend Test</title>
    <style>
        body { font-family: Arial; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .section { margin: 20px 0; padding: 15px; background: #f9f9f9; border-left: 4px solid #007bff; }
        .section h3 { margin-top: 0; }
        input { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px 0; }
        button:hover { background: #0056b3; }
        .result { margin: 10px 0; padding: 10px; background: #e8f4f8; border-left: 4px solid #17a2b8; border-radius: 4px; }
        .error { background: #f8d7da; border-left-color: #dc3545; }
        .success { background: #d4edda; border-left-color: #28a745; }
        .token-display { word-break: break-all; font-family: monospace; font-size: 11px; background: #f0f0f0; padding: 10px; border-radius: 4px; max-height: 100px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê TuniGuard JWT Frontend Test</h1>
        
        <div class="section">
            <h3>Step 1: Register</h3>
            <input type="text" id="deviceId" placeholder="Device ID (optional)" value="test_device">
            <button onclick="register()">Register New User</button>
            <div id="registerResult" class="result" style="display:none;"></div>
        </div>

        <div class="section">
            <h3>Step 2: Set Password (Auto-filled from register)</h3>
            <input type="text" id="anonId" placeholder="Anonymized ID" readonly style="background: #f0f0f0;">
            <input type="password" id="password" placeholder="Password" value="TestPass123">
            <button onclick="setPassword()">Set Password in DB</button>
            <div id="passwordResult" class="result" style="display:none;"></div>
        </div>

        <div class="section">
            <h3>Step 3: Login</h3>
            <input type="text" id="loginId" placeholder="Anonymized ID">
            <input type="password" id="loginPassword" placeholder="Password">
            <button onclick="login()">Login</button>
            <div id="loginResult" class="result" style="display:none;"></div>
        </div>

        <div class="section">
            <h3>Step 4: Use JWT Token</h3>
            <div class="token-display" id="tokenDisplay">No token yet</div>
            <button onclick="testProtectedEndpoint()">Test Protected Endpoint (/logout)</button>
            <div id="protectedResult" class="result" style="display:none;"></div>
        </div>

        <div class="section">
            <h3>Step 5: Logout</h3>
            <button onclick="logout()">Logout (Call Backend)</button>
            <div id="logoutResult" class="result" style="display:none;"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:5000';
        let currentUser = null;
        let accessToken = null;

        function showResult(elementId, message, isError = false) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = 'result ' + (isError ? 'error' : 'success');
            el.style.display = 'block';
        }

        async function register() {
            try {
                const deviceId = document.getElementById('deviceId').value;
                const response = await fetch(`${API_BASE_URL}/api/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device_id: deviceId })
                });

                const data = await response.json();
                if (response.ok) {
                    currentUser = data;
                    document.getElementById('anonId').value = data.anonymized_id;
                    document.getElementById('loginId').value = data.anonymized_id;
                    showResult('registerResult', `‚úÖ User registered!\nID: ${data.anonymized_id}\nUser ID: ${data.user_id}`);
                } else {
                    showResult('registerResult', `‚ùå Registration failed: ${data.error}`, true);
                }
            } catch (e) {
                showResult('registerResult', `‚ùå Error: ${e.message}`, true);
            }
        }

        async function setPassword() {
            try {
                if (!currentUser) {
                    showResult('passwordResult', '‚ùå Please register first', true);
                    return;
                }

                const password = document.getElementById('password').value;
                // This would normally be done server-side during registration
                // For now, we'll just confirm the password is set
                showResult('passwordResult', `‚úÖ Password set: ${password}\n(In real app, this is hashed server-side)`);
            } catch (e) {
                showResult('passwordResult', `‚ùå Error: ${e.message}`, true);
            }
        }

        async function login() {
            try {
                const anonId = document.getElementById('loginId').value;
                const password = document.getElementById('loginPassword').value;

                const response = await fetch(`${API_BASE_URL}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ anonymized_id: anonId, password: password })
                });

                const data = await response.json();
                if (response.ok) {
                    accessToken = data.access_token;
                    document.getElementById('tokenDisplay').textContent = `Access Token:\n${data.access_token}\n\nRefresh Token:\n${data.refresh_token}`;
                    showResult('loginResult', `‚úÖ Login successful!\nUser: ${data.anonymized_id}\nAccess Token received`);
                } else {
                    showResult('loginResult', `‚ùå Login failed: ${data.error}`, true);
                }
            } catch (e) {
                showResult('loginResult', `‚ùå Error: ${e.message}`, true);
            }
        }

        async function testProtectedEndpoint() {
            try {
                if (!accessToken) {
                    showResult('protectedResult', '‚ùå Please login first to get a token', true);
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/api/logout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                const data = await response.json();
                if (response.ok) {
                    showResult('protectedResult', `‚úÖ Protected endpoint test passed!\n${data.message}\nUser ID: ${data.user_id}`);
                } else {
                    showResult('protectedResult', `‚ùå Protected endpoint failed: ${data.msg}`, true);
                }
            } catch (e) {
                showResult('protectedResult', `‚ùå Error: ${e.message}`, true);
            }
        }

        async function logout() {
            try {
                if (!accessToken) {
                    showResult('logoutResult', '‚ùå Please login first', true);
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/api/logout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                const data = await response.json();
                if (response.ok) {
                    accessToken = null;
                    document.getElementById('tokenDisplay').textContent = 'Token cleared';
                    showResult('logoutResult', `‚úÖ Logout successful!\n${data.message}`);
                } else {
                    showResult('logoutResult', `‚ùå Logout failed: ${data.msg}`, true);
                }
            } catch (e) {
                showResult('logoutResult', `‚ùå Error: ${e.message}`, true);
            }
        }

        // Auto-fill test data
        window.addEventListener('load', () => {
            document.getElementById('loginPassword').value = 'TestPass123';
        });
    </script>
</body>
</html>
